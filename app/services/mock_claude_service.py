from typing import Dict, Any, List, Optional
import json
import re

class MockClaudeService:
    """
    Claude API를 호출하지 않고 테스트하기 위한 Mock 서비스
    """
    
    def __init__(self):
        pass
    
    def extract_json_from_text(self, text: str) -> Dict[str, Any]:
        """
        텍스트에서 JSON 내용을 추출하는 함수
        여러 방법으로 추출을 시도하며, 가능한 형식:
        1. 일반 JSON 객체
        2. 마크다운 코드 블록 내 JSON (```json ... ```)
        3. 중괄호({})로 둘러싸인 내용
        """
        # 방법 1: 전체 텍스트가 JSON인 경우
        try:
            return json.loads(text)
        except json.JSONDecodeError:
            pass
        
        # 방법 2: 마크다운 코드 블록에서 JSON 추출
        json_code_block = re.search(r'```(?:json)?\s*([\s\S]*?)\s*```', text)
        if json_code_block:
            try:
                return json.loads(json_code_block.group(1))
            except json.JSONDecodeError:
                pass
        
        # 방법 3: 텍스트에서 중괄호로 둘러싸인 부분 찾기
        json_braces = re.search(r'({[\s\S]*?})', text)
        if json_braces:
            try:
                return json.loads(json_braces.group(1))
            except json.JSONDecodeError:
                pass
        
        # 모든 방법이 실패하면 원본 텍스트를 반환
        return {"raw_response": text}
    
    async def analyze_legal_issue(self, description: str) -> Dict[str, Any]:
        """사용자의 법률 문제를 분석하여 관련 법률 분야와 키워드 추출 (모의 응답)"""
        
        # 임대차 계약 관련 응답
        if "임대차" in description or "전세" in description or "월세" in description or "세입자" in description:
            return {
                "legal_category": "부동산/임대차",
                "key_issues": ["임대차계약 중도해지", "계약기간 보장", "임대인의 일방적 해지", "손해배상"],
                "keywords": ["임대차", "주택임대차보호법", "계약기간", "보증금", "이사비용", "손해배상"],
                "relevant_laws": ["주택임대차보호법", "민법"]
            }
        # 노동 관련 응답
        elif "퇴직금" in description or "해고" in description or "직장" in description or "근로" in description:
            return {
                "legal_category": "노동/근로관계",
                "key_issues": ["부당해고", "퇴직금", "임금체불", "근로계약"],
                "keywords": ["근로기준법", "퇴직금", "해고", "임금", "근로계약"],
                "relevant_laws": ["근로기준법", "근로자퇴직급여 보장법"]
            }
        # 기본 응답
        else:
            return {
                "legal_category": "일반 민사",
                "key_issues": ["계약 분쟁", "손해배상"],
                "keywords": ["계약", "손해배상", "민법"],
                "relevant_laws": ["민법"]
            }
    
    async def summarize_legal_info(self, laws: List[Dict], cases: List[Dict]) -> Dict[str, Any]:
        """법령과 판례 정보를 요약하고 쉽게 해석 (모의 응답)"""
        
        # 임대차 관련 요약
        if any("임대차" in law.get("lawName", "") for law in laws):
            return {
                "simplified_laws": [
                    {
                        "law_name": "주택임대차보호법",
                        "explanation": "임대인은 계약기간이 끝나기 전에 일방적으로 계약을 해지할 수 없습니다. 임차인은 계약기간이 끝날 때까지 거주할 권리가 있으며, 임대인의 일방적인 계약 해지 요구는 불법입니다."
                    },
                    {
                        "law_name": "민법",
                        "explanation": "계약은 양 당사자의 합의에 따라 성립하고 해지됩니다. 일방적인 계약 해지는 상대방에게 손해배상 책임을 질 수 있습니다."
                    }
                ],
                "simplified_cases": [
                    {
                        "case_no": "대법원 2019다12345",
                        "explanation": "임대인이 계약기간 중 임차인에게 퇴거를 요구한 사례에서, 정당한 사유 없는 퇴거 요구는 불법이며 이로 인한 손해배상 책임이 있다고 판결했습니다.",
                        "implications": "임대인은 계약기간 중 정당한 사유 없이 퇴거를 요구할 수 없으며, 이를 위반할 경우 손해배상 책임을 질 수 있습니다."
                    }
                ],
                "user_rights": [
                    "계약기간 동안 주택에 거주할 권리",
                    "임대인의 부당한 퇴거 요구에 응하지 않을 권리",
                    "계약 위반으로 인한 손해배상을 청구할 권리"
                ],
                "user_obligations": [
                    "약정된 월세를 정시에 지급할 의무",
                    "주택을 훼손하지 않고 관리할 의무",
                    "계약 종료 시 원상복구하여 반환할 의무"
                ]
            }
        # 기본 요약
        else:
            return {
                "simplified_laws": [
                    {
                        "law_name": "민법",
                        "explanation": "계약은 양 당사자의 합의에 따라 성립하고 해지됩니다. 일방적인 계약 해지는 상대방에게 손해배상 책임을 질 수 있습니다."
                    }
                ],
                "simplified_cases": [],
                "user_rights": [
                    "계약 내용에 따른 권리 행사",
                    "계약 위반에 대한 손해배상 청구권"
                ],
                "user_obligations": [
                    "계약 내용을 성실히 이행할 의무"
                ]
            }
    
    async def generate_document_draft(self, doc_type: str, case_info: Dict[str, Any], 
                                     recipient_info: Optional[Dict[str, Any]] = None) -> str:
        """법률 문서 초안 생성 (내용증명, 이의제기서 등) (모의 응답)"""
        
        # 내용증명 문서 (임대차 관련)
        if doc_type == "내용증명" and "임대차" in case_info.get("legal_category", ""):
            return f"""
내용증명

발신인: [발신인 이름]
        [발신인 주소]
        [발신인 연락처]

수신인: {recipient_info.get('name', '[수신인 이름]')}
        {recipient_info.get('address', '[수신인 주소]')}
        {recipient_info.get('contact', '[수신인 연락처]')}

제목: 임대차 계약 관련 통지

수신인 귀하,

본 내용증명은 귀하와 체결한 임대차 계약과 관련하여 발송합니다.

1. 계약 관계
   - 임대차 목적물: [주소]
   - 계약 기간: [시작일] ~ [종료일]
   - 보증금: 1,000만원
   - 월 임대료: 50만원

2. 문제 상황
   귀하는 계약 기간이 6개월 남은 상황에서 일방적으로 퇴거를 요구하셨습니다. 이는 주택임대차보호법 및 민법상 계약 위반에 해당합니다.

3. 통지 내용
   1) 본인은 귀하의 일방적인 퇴거 요구를 거부합니다.
   2) 계약 기간이 만료되는 [종료일]까지 거주할 권리를 행사하겠습니다.
   3) 귀하의 계약 위반 행위로 인한 손해배상을 청구할 수 있음을 알려드립니다.

4. 요청 사항
   1) 귀하의 퇴거 요구를 즉시 철회해 주시기 바랍니다.
   2) 계약 기간 만료일까지 임차인의 거주 권리를 보장해 주시기 바랍니다.
   3) 계약 조건에 따른 의무를 성실히 이행해 주시기 바랍니다.

본 내용증명을 통해 통지한 내용을 확인하시고, 본 서신을 받은 날로부터 7일 이내에 서면으로 회신해 주시기 바랍니다.

[날짜]

발신인: [발신인 이름] (서명)
            """
        # 기본 문서
        else:
            return f"""
{doc_type}

발신인: [발신인 이름]
        [발신인 주소]
        [발신인 연락처]

수신인: {recipient_info.get('name', '[수신인 이름]') if recipient_info else '[수신인 이름]'}
        {recipient_info.get('address', '[수신인 주소]') if recipient_info else '[수신인 주소]'}
        {recipient_info.get('contact', '[수신인 연락처]') if recipient_info else '[수신인 연락처]'}

제목: {case_info.get('title', '법률 문제 관련 통지')}

수신인 귀하,

본 문서는 다음 사항과 관련하여 발송합니다:

1. 배경 상황
   [관련 상황 설명]

2. 문제점
   [문제점 기술]

3. 법적 근거
   [관련 법률 조항]

4. 요청 사항
   [구체적인 요청 내용]

본 문서를 통해 통지한 내용을 확인하시고, 본 서신을 받은 날로부터 14일 이내에 서면으로 회신해 주시기 바랍니다.

[날짜]

발신인: [발신인 이름] (서명)
            """
    
    async def generate_legal_consultation(self, user_description: str, laws: List[Dict], cases: List[Dict]) -> str:
        """
        사용자의 법률 문제와 관련 법령 및 판례를 바탕으로 종합적인 법률 상담 답변 생성
        사용자가 구체적으로 어떻게 대응해야 하는지에 대한 단계별 안내 포함
        """
        # 임대차 관련 상담
        if "임대차" in user_description or "전세" in user_description or "월세" in user_description or "세입자" in user_description:
            return """
# 법률 상담 답변

## 1. 문제 요약
귀하는 월세 50만원, 보증금 1000만원으로 2년 계약한 세입자로, 계약기간이 아직 6개월 남았으나 집주인이 갑자기 다음 달까지 퇴거를 요구하고 이사비용도 지급하지 않겠다고 하는 상황에 처해 있습니다.

## 2. 법적 분석
주택임대차보호법과 민법에 따르면, 임대인은 계약기간 중에 정당한 사유 없이 임차인에게 퇴거를 요구할 수 없습니다. 계약은 양 당사자를 구속하는 법적 효력이 있으며, 일방적으로 파기할 수 없습니다. 따라서 집주인의 퇴거 요구는 법적으로 유효하지 않으며, 귀하는 계약기간이 끝날 때까지 거주할 권리가 있습니다.

## 3. 사용자의 권리와 의무

### 권리:
- 계약기간 동안 주택에 거주할 권리
- 임대인의 부당한 퇴거 요구에 응하지 않을 권리
- 계약 위반으로 인한 손해배상을 청구할 권리
- 계약 종료 시 보증금을 전액 반환받을 권리

### 의무:
- 월세를 정시에 지급할 의무
- 주택을 훼손하지 않고 관리할 의무
- 계약 종료 시 원상복구하여 반환할 의무

## 4. 대응 방안

### 옵션 1: 대화를 통한 해결
- 장점: 빠르고 원만한 해결 가능, 관계 유지 가능
- 단점: 임대인이 협조적이지 않을 경우 효과 제한적

### 옵션 2: 내용증명 발송
- 장점: 공식적인 의사 표시 기록 남김, 법적 효력 확보
- 단점: 관계 악화 가능성, 반응이 없을 경우 추가 조치 필요

### 옵션 3: 분쟁조정 신청
- 장점: 전문가 개입으로 합리적 해결 가능, 소송보다 비용과 시간 절약
- 단점: 양 당사자 참여 필요, 조정 결과에 강제력 부족

### 옵션 4: 법적 조치
- 장점: 강제력 있는 해결, 권리 보호 확실
- 단점: 비용과 시간 소요, 관계 단절

## 5. 단계별 행동 계획

1. **준비 단계**:
   - 임대차 계약서 확인 및 안전한 보관
   - 지금까지의 월세 납부 증빙 수집
   - 임대인과의 대화 내용 기록 (문자메시지, 통화 녹음 등)

2. **대화 시도**:
   - 임대인에게 법적 상황을 설명하고 계약 준수 요청
   - 계약기간 동안 거주 의사 명확히 전달
   - 가능하다면 대화 내용 기록 (통화 녹음 시 사전 고지 필요)

3. **내용증명 발송** (대화로 해결되지 않을 경우):
   - 우체국에서 내용증명 양식 수령 또는 온라인 서비스 이용
   - 내용에 계약관계, 문제상황, 법적 근거, 요구사항 명시
   - 회신 기한 설정 (보통 7일)

4. **분쟁조정 신청** (내용증명에 응하지 않을 경우):
   - 주택임대차분쟁조정위원회에 조정 신청
   - 관할 법원 또는 대한법률구조공단에 문의

5. **법적 조치** (필요시):
   - 법률 전문가 상담
   - 가처분 신청 (퇴거 강요 시)
   - 손해배상 청구 소송 준비

## 6. 필요 서류/증거
- 임대차 계약서 원본
- 월세 납부 증빙 (계좌이체 내역, 영수증 등)
- 임대인과의 대화 기록 (문자메시지, 이메일, 통화 녹음 등)
- 내용증명 발송 기록 및 수령 확인증
- 주택 상태 사진 (현재 상태 기록용)

## 7. 법적 시간 제한
- 내용증명 발송 후 회신 기한: 7일 권장
- 조정 신청: 분쟁 발생 시 가능한 빨리 신청
- 임대차 계약 관련 소멸시효: 일반적으로 10년

## 8. 전문가 도움 여부
임대인이 지속적으로 퇴거를 요구하거나 실제로 방해 행위(출입 제한, 공과금 중단 등)를 할 경우, 법률 전문가의 도움을 받는 것이 좋습니다. 대한법률구조공단에서 무료 법률 상담을 제공하며, 주택임대차보호법 관련 사례는 비교적 명확하여 효과적인 조언을 받을 수 있습니다.

현재로서는 귀하의 법적 지위가 안전하므로, 내용증명 발송 단계까지는 직접 진행하셔도 무방합니다. 그러나 실제 강제 퇴거 시도가 있거나 법적 분쟁으로 확대될 경우 변호사 상담을 받으시기 바랍니다.
            """
        # 노동 관련 상담
        elif "퇴직금" in user_description or "해고" in user_description or "직장" in user_description or "근로" in user_description:
            return """
# 법률 상담 답변

## 1. 문제 요약
귀하는 직장에서 갑작스럽게 해고 통보를 받았으며, 퇴직금 지급을 거부당하는 상황에 처해 있습니다.

## 2. 법적 분석
근로기준법에 따르면, 사용자는 정당한 이유 없이 근로자를 해고할 수 없으며, 해고하려면 최소 30일 전에 예고하거나 30일분 이상의 통상임금을 지급해야 합니다. 또한 1년 이상 근무한 근로자에게는 퇴직금을 지급해야 할 법적 의무가 있습니다.

## 3. 사용자의 권리와 의무

### 권리:
- 부당해고에 대한 구제신청 권리
- 퇴직금을 지급받을 권리
- 해고예고수당을 청구할 권리
- 미지급 임금에 대한 청구권

### 의무:
- 회사 자산 및 비밀정보 보호 의무
- 인수인계 의무 (합리적인 범위 내에서)

## 4. 대응 방안
(이하 대응 방안 상세 내용)

## 5. 단계별 행동 계획
(이하 단계별 행동 계획 상세 내용)

## 6. 필요 서류/증거
(이하 필요 서류/증거 상세 내용)

## 7. 법적 시간 제한
(이하 법적 시간 제한 상세 내용)

## 8. 전문가 도움 여부
(이하 전문가 도움 여부 상세 내용)
            """
        # 기본 상담
        else:
            return """
# 법률 상담 답변

## 1. 문제 요약
[사용자의 법률 문제 요약]

## 2. 법적 분석
[관련 법령과 판례를 바탕으로 사용자의 법적 상황 분석]

## 3. 사용자의 권리와 의무
[현 상황에서 사용자가 가진 법적 권리와 의무 설명]

## 4. 대응 방안
[구체적인 대응 방법 제시]

## 5. 단계별 행동 계획
[사용자가 취해야 할 구체적인 행동을 순차적으로 안내]

## 6. 필요 서류/증거
[준비해야 할 서류나 확보해야 할 증거 안내]

## 7. 법적 시간 제한
[관련 소멸시효나 기한]

## 8. 전문가 도움 여부
[변호사 상담이 필요한 시점과 이유 안내]
            """
    
    async def _call_claude_api(self, prompt: str) -> str:
        """Mock Claude API 호출 함수"""
        
        # 임대차 관련 응답
        if "임대차" in prompt or "전세" in prompt or "월세" in prompt or "세입자" in prompt:
            return """
# 법률 상담 답변

## 1. 문제 요약
귀하는 월세 50만원, 보증금 1000만원으로 2년 계약한 세입자로, 계약기간이 아직 6개월 남았으나 집주인이 갑자기 다음 달까지 퇴거를 요구하고 이사비용도 지급하지 않겠다고 하는 상황에 처해 있습니다.

## 2. 적용 법령 및 판례
이 사안에는 주택임대차보호법과 민법이 적용됩니다. 주택임대차보호법은 임차인의 주거안정을 보호하기 위한 법률로, 임대인은 정당한 사유 없이 계약기간 중 퇴거를 요구할 수 없습니다. 대법원은 여러 판례를 통해 임대인의 일방적인 계약 해지 요구가 불법이며, 이로 인한 손해배상 책임이 있다고 판시한 바 있습니다.

## 3. 법률적 견해
집주인의 일방적인 퇴거 요구는 법적으로 유효하지 않습니다. 임대차 계약은 계약기간 동안 양측을 구속하는 법적 효력이 있으며, 정당한 사유(예: 임차인의 월세 체납, 주택의 불법 사용 등) 없이 임대인이 일방적으로 해지할 수 없습니다. 따라서 귀하는 계약기간이 만료되는 시점까지 해당 주택에 거주할 권리가 있습니다.

## 4. 권리와 의무
귀하의 권리:
- 계약기간 동안 주택에 거주할 권리
- 임대인의 부당한 퇴거 요구에 응하지 않을 권리
- 임대인의 계약 위반으로 인한 손해배상을 청구할 권리
- 계약 종료 시 보증금을 전액 반환받을 권리

귀하의 의무:
- 월세를 정시에 지급할 의무
- 주택을 훼손하지 않고 관리할 의무
- 계약 종료 시 원상복구하여 반환할 의무

## 5. 대응 방안
1. **서면 통지**: 임대인에게 내용증명 우편으로 퇴거 요구가 법적으로 유효하지 않음을 알리고, 계약기간 동안 거주할 의사를 명확히 전달하세요.

2. **증거 수집**: 임대차계약서, 임대인과의 통화 녹음(사전 고지 필요), 문자메시지 등 관련 증거를 보관하세요.

3. **법률 상담**: 필요시 대한법률구조공단이나 변호사를 통해 무료 또는 저렴한 법률 상담을 받으세요.

4. **조정 신청**: 주택임대차분쟁조정위원회에 분쟁 조정을 신청할 수 있습니다.

5. **법적 대응**: 임대인이 지속적으로 퇴거를 요구하거나 방해행위를 할 경우, 주택임대차보호법 위반으로 법적 조치를 취할 수 있습니다.

귀하는 법적으로 보호받을 권리가 있으며, 임대인의 일방적인 퇴거 요구에 응할 필요가 없습니다. 계약기간 동안 월세를 정상적으로 납부하며 거주하시면 됩니다.
            """
        # 기본 응답
        else:
            return """
# 법률 상담 답변

## 1. 문제 요약
[사용자의 법률 문제 요약]

## 2. 적용 법령 및 판례
이 사안에는 [관련 법령]이 적용됩니다. [법령 설명]

## 3. 법률적 견해
[법률적 견해 제시]

## 4. 권리와 의무
귀하의 권리:
- [권리 1]
- [권리 2]
- [권리 3]

귀하의 의무:
- [의무 1]
- [의무 2]
- [의무 3]

## 5. 대응 방안
1. [대응 방안 1]
2. [대응 방안 2]
3. [대응 방안 3]
4. [대응 방안 4]
5. [대응 방안 5]

[결론적 조언]
            """
